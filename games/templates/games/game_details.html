{% extends 'index.html' %}

{% block page_title %}
    Game Details {{ game.when }}
{% endblock %}

{% block content %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 p-6 max-w-full bg-base-100 rounded-lg shadow-lg">

        <div class="flex flex-col items-center space-y-6 p-4">
            <form method="post"
                  action="{% url 'game_status_update_url' game_id=game.id %}"
                  class="bg-base-100 p-6 rounded-lg text-gray-100">
                {% csrf_token %}
                <div class="text-xl font-bold m-3 w-full">
                    Week {{ game.when|date:'W - d M Y ' }}
                    <div class="flex justify-center w-full mt-10 mb-10">
                        {% if number_of_confirmed_players > 10 %}
                        <div class="radial-progress text-success"
                             style="--size:100px; --thickness: 1rem; --value:{% widthratio number_of_confirmed_players 1 10 %};"
                             aria-valuenow="{{ number_of_confirmed_players }}"
                             role="progressbar">10+</div>
                        {% elif number_of_confirmed_players == 10 %}
                            <div class="radial-progress text-success"
                                 style="--size:100px; --thickness: 1rem; --value:{% widthratio number_of_confirmed_players 1 10 %};"
                                 aria-valuenow="{{ number_of_confirmed_players }}"
                                 role="progressbar">{{ number_of_confirmed_players }}</div>
                        {% elif number_of_confirmed_players == 9 %}
                            <div class="radial-progress text-green-200"
                                 style="--size:100px; --thickness: 1rem; --value:{% widthratio number_of_confirmed_players 1 10 %};"
                                 aria-valuenow="{{ number_of_confirmed_players }}"
                                 role="progressbar">{{ number_of_confirmed_players }}</div>
                        {% elif number_of_confirmed_players == 8 %}
                            <div class="radial-progress text-warning"
                                 style="--size:100px; --thickness: 1rem; --value:{% widthratio number_of_confirmed_players 1 10 %};"
                                 aria-valuenow="{{ number_of_confirmed_players }}"
                                 role="progressbar">{{ number_of_confirmed_players }}</div>
                        {% else %}
                            <div class="radial-progress text-error"
                                 style="--size:100px; --thickness: 1rem; --value:{% widthratio number_of_confirmed_players 1 10 %};"
                                 aria-valuenow="{{ number_of_confirmed_players }}"
                                 role="progressbar">{{ number_of_confirmed_players }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-4 mt-2">
                        <label for="status" class="block mb-1 font-semibold text-zinc-400">Status</label>
                        {% if user.is_superuser %}
                            <select id="status" name="status"
                                    class="select select-bordered w-full max-w-xs bg-gray-700 text-gray-100">
                                {% for status_option in status_options %}
                                    <option value="{{ status_option }}"
                                            {% if status_option == game.status %}selected{% endif %}>
                                        {{ status_option }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <select id="status" name="status" disabled
                                    class="select select-bordered w-full max-w-xs bg-gray-700 text-gray-600 cursor-not-allowed">
                                {% for status_option in status_options %}
                                    <option value="{{ status_option }}"
                                            {% if status_option == game.status %}selected{% endif %}>
                                        {{ status_option }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    </div>
                    <div>
                        <label for="description" class="block mb-1 font-semibold text-zinc-400">Description</label>
                        {% if user.is_superuser %}
                            <textarea id="description" name="description" rows="3"
                                      class="textarea textarea-bordered w-full max-w-xs bg-gray-800 text-gray-100">{{ game.description }}</textarea>
                        {% else %}
                            <textarea id="description" rows="3" readonly
                                      class="textarea textarea-bordered w-full max-w-xs bg-gray-700 text-gray-600"
                            >{{ game.description }}</textarea>
                        {% endif %}
                    </div>
                    {% if user.is_authenticated and user.is_superuser %}
                        <button type="submit" class="mt-8 btn btn-primary w-full">
                            Update Game Details
                        </button>
                    {% endif %}
                </div>
            </form>

        </div>

        <div class="p-4">

            <div class="font-bold bg-gray-700 text-gray-200 px-2 py-1 rounded mt-4 mb-2 text-center">
                Permanent players
            </div>
            <div class="flex items-center font-bold text-gray-300 rounded-t p-2">
                <span class="w-28 text-center">Play</span>
                <span class="w-48 text-center">Player</span>
                <span class="w-48 text-center">Substitute Player</span>
            </div>
            <div class="divide-y divide-gray-600 rounded-b">

                {% for planned_player in planned_players_for_game %}
                    <form method="post" action="{% url 'game_player_status_update_url' game_id=game.id %}">
                        {% csrf_token %}
                        <div class="flex items-center py-2">
                            <label for="play_slot_{{ planned_player.pk }}" class="flex justify-center w-28">
                                {% if user.is_superuser or planned_player.user.username == user.username %}

                                    <input type="hidden" name="play_slot_{{ planned_player.pk }}" value="off">
                                    <input type="checkbox"
                                           name="play_slot_{{ planned_player.pk }}"
                                           value="on"
                                           id="play_slot_{{ planned_player.pk }}"
                                           class="toggle toggle-primary"
                                           checked
                                           onchange="this.form.submit()">
                                {% else %}
                                    <div style="width: 64px; height: 24px;"></div>
                                {% endif %}
                            </label>
                            <span class="w-48 text-center text-gray-300">{{ planned_player.user.username }}</span>
                            <span class="w-48 flex justify-center"></span>
                        </div>
                    </form>
                {% endfor %}
                {% for cancelled_player, substitute in cancelled_with_substitutes %}
                    <form method="post" action="{% url 'game_player_status_update_url' game_id=game.id %}">
                        {% csrf_token %}
                        <div class="flex items-center py-2">
                            <label for="play_slot_{{ cancelled_player.pk }}" class="flex justify-center w-28">
                                {% if user.is_superuser or cancelled_player.user.username == user.username %}

                                    <input type="hidden" name="play_slot_{{ cancelled_player.pk }}" value="off">
                                    <input type="checkbox"
                                           name="play_slot_{{ cancelled_player.pk }}"
                                           value="on"
                                           id="play_slot_{{ cancelled_player.pk }}"
                                           class="toggle toggle-primary"
                                           {% if cancelled_player in confirmed_players_for_game %}checked{% endif %}
                                           onchange="this.form.submit()">
                                {% else %}
                                    <div style="width: 64px; height: 24px;"></div>
                                {% endif %}
                            </label>
                            <span class="w-48 text-center text-gray-300">{{ cancelled_player.user.username }}</span>
                            <span class="w-48 flex justify-center">
                            {% if substitute %}
                                <span class="badge badge-success">{{ substitute.user.username }}</span>
                            {% else %}
                                <span class="badge badge-error text-error-content">free slot</span>
                            {% endif %}
                        </span>
                        </div>
                    </form>
                {% endfor %}

                <div class="font-bold bg-gray-700 text-gray-200 px-2 py-1 rounded mt-4 mb-2 text-center">
                    Reserved players
                </div>
                <div class="flex items-center font-bold text-gray-300 rounded-t p-2">
                    <span class="w-28 text-center">Play</span>
                    <span class="w-48 text-center">Player</span>
                    {#                    <span class="w-48 text-center">Temporarily for Player</span>#}
                </div>

                {% for confirmed_player in confirmed_players_for_game %}
                    <form method="post" action="{% url 'game_player_status_update_url' game_id=game.id %}">
                        {% csrf_token %}
                        <div class="flex items-center py-2">
                            <label for="play_slot_{{ confirmed_player.pk }}" class="flex justify-center w-28">
                                {% if user.is_superuser or confirmed_player.user.username == user.username %}
                                    <input type="hidden" name="play_slot_{{ confirmed_player.pk }}" value="off">
                                    <input type="checkbox"
                                           name="play_slot_{{ confirmed_player.pk }}"
                                           value="on"
                                           id="play_slot_{{ confirmed_player.pk }}"
                                           class="toggle toggle-primary"
                                           checked
                                           onchange="this.form.submit()">
                                {% else %}
                                    <div style="width: 64px; height: 24px;"></div>
                                {% endif %}
                            </label>
                            <span class="w-48 text-center text-gray-300">{{ confirmed_player.user.username }}</span>
                        </div>
                    </form>
                {% endfor %}
                {% for reserved_player in reserved_players_for_game %}
                    <form method="post" action="{% url 'game_player_status_update_url' game_id=game.id %}">
                        {% csrf_token %}
                        <div class="flex items-center py-2">
                            <label for="play_slot_{{ reserved_player.pk }}" class="flex justify-center w-28">
                                {% if user.is_superuser or reserved_player.user.username == user.username %}
                                    <input type="hidden" name="play_slot_{{ reserved_player.pk }}" value="off">
                                    <input type="checkbox"
                                           name="play_slot_{{ reserved_player.pk }}"
                                           value="on"
                                           id="play_slot_{{ reserved_player.pk }}"
                                           class="toggle toggle-primary"
                                           {% if reserved_player in confirmed_players_for_game %}checked{% endif %}
                                           onchange="this.form.submit()">
                                {% else %}
                                    <div style="width: 64px; height: 24px;"></div>
                                {% endif %}
                            </label>
                            <span class="w-48 text-center text-gray-300">{{ reserved_player.user.username }}</span>
                        </div>
                    </form>
                {% endfor %}
            </div>

        </div>

        <div class="p-4 flex flex-col gap-4">
            <div class="card shadow-lg text-center bg-base-100 text-xl font-semibold">
                Booking history for this game
            </div>
            <table class="table">
                <thead>
                <tr>
                    <th>Player</th>
                    <th>Status for Player</th>
                    <th>Created</th>
                </tr>
                </thead>
                <tbody>
                {% for record in booking_history %}
                    <tr>
                        {% if record.player.user.username != 'N/A' %}
                            <td>{{ record.player.user.username }}</td>
                        {% else %}
                            <td>{{ record.player.name }} {{ record.player.surname }}</td>
                        {% endif %}
                        <td>{{ record.player_status.player_status }}</td>
                        <td>{{ record.creation_date|date:'d M Y, H:i:s' }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

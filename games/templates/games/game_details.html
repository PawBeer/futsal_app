{% extends 'index.html' %}
{% load player_extras %}
{% block page_title %}
    Game Details {{ game.when }}
{% endblock %}

{% block content %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 p-2 max-w-full bg-base-100 rounded-lg shadow-lg">

        <div class="flex flex-col items-center space-y-6 p-6 bg-base-100 rounded-xl shadow-lg">
            <form method="post" action="{% url 'game_status_update_url' game_id=game.id %}"
                  class="w-full max-w-md space-y-6">
                {% csrf_token %}

                <div class="text-center">
                    <p class="text-xl md:text-3xl lg:text-4xl text-base-content font-bold tracking-tight mb-4">
                        {{ game.when|date:'d M Y' }}
                    </p>

                    <div class="flex justify-center mb-8">
                        {% if number_of_confirmed_players >= 10 %}
                            <div class="radial-progress bg-primary/10 text-success font-bold text-xl"
                                 style="--size:120px; --thickness: 8px; --value:100;"
                                 role="progressbar" aria-valuenow="{{ number_of_confirmed_players }}">
                                10+
                            </div>
                        {% elif number_of_confirmed_players >= 8 %}
                            <div class="radial-progress bg-success/10 text-warning font-bold text-xl"
                                 style="--size:120px; --thickness: 8px; --value:{% widthratio number_of_confirmed_players 1 10 %};"
                                 role="progressbar">{{ number_of_confirmed_players }}</div>
                        {% else %}
                            <div class="radial-progress bg-error/10 text-error font-bold text-xl"
                                 style="--size:120px; --thickness: 8px; --value:{% widthratio number_of_confirmed_players 1 10 %};"
                                 role="progressbar">{{ number_of_confirmed_players }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-control w-full max-w-xs mx-auto">
                    <label for="status" class="label">
                        <span class="label-text font-semibold text-base-content/90">Status</span>
                    </label>
                    {% if user.is_superuser %}
                        <select id="status" name="status" class="select select-bordered w-full">
                            {% for status_option in status_options %}
                                <option value="{{ status_option }}"
                                        {% if status_option == game.status %}selected{% endif %}>
                                    {{ status_option }}
                                </option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <div class="font-semibold text-base-content/90 bg-base-200 px-4 py-3 rounded-lg cursor-default select-none">
                            {{ game.status }}
                        </div>
                    {% endif %}
                </div>

                <div class="form-control w-full max-w-xs mx-auto">
                    <label for="description" class="label">
                        <span class="label-text font-semibold text-base-content/90">Description</span>
                    </label>
                    {% if user.is_superuser %}
                        <textarea id="description" name="description" rows="4"
                                  class="textarea textarea-bordered w-full resize-vertical">{{ game.description }}</textarea>
                    {% else %}
                        <div class="font-medium text-base-content/90 bg-base-200 px-4 py-3 rounded-lg cursor-default select-none min-h-[100px] flex items-start leading-relaxed pt-2">
                            {{ game.description|default:"No description" }}
                        </div>
                    {% endif %}
                </div>


                {% if user.is_authenticated and user.is_superuser %}
                    <div class="pt-4">
                        <button type="submit" class="btn btn-primary w-full shadow-lg hover:shadow-xl">
                            Update Game Details
                        </button>
                    </div>
                {% endif %}
            </form>
        </div>


        <div class="p-4">

            <div class="font-bold bg-gray-700 text-gray-200 px-2 py-1 rounded mt-4 mb-2 text-center">
                Permanent players
            </div>
            <div class="flex items-center font-bold text-gray-300 rounded-t p-2">
                <span class="w-28 text-center">Play</span>
                <span class="w-48 text-center">Player</span>
                <span class="w-48 text-center">Substitute Player</span>
            </div>
            <div class="divide-y divide-gray-600 rounded-b">

                {% for planned_player in planned_players_for_game %}
                    <form method="post" action="{% url 'game_player_status_update_url' game_id=game.id %}">
                        {% csrf_token %}
                        <div class="flex items-center py-2">
                            <label for="play_slot_{{ planned_player.pk }}" class="flex justify-center w-28">
                                {% if user.is_superuser or planned_player.user.username == user.username %}

                                    <input type="hidden" name="play_slot_{{ planned_player.pk }}" value="off">
                                    <input type="checkbox"
                                           name="play_slot_{{ planned_player.pk }}"
                                           value="on"
                                           id="play_slot_{{ planned_player.pk }}"
                                           class="toggle toggle-primary"
                                           checked
                                           onchange="this.form.submit()">
                                {% else %}
                                    <div style="width: 64px; height: 24px;"></div>
                                {% endif %}
                            </label>
                            <span class="w-48 text-center dark:text-gray-300"><a
                                    href="{% url 'player_details_url' player_id=planned_player.pk %}">{{ planned_player|get_display_name }}</a></span>
                            <span class="w-48 flex justify-center"></span>
                        </div>
                    </form>
                {% endfor %}
                {% for cancelled_player, substitute in cancelled_with_substitutes %}
                    <form method="post" action="{% url 'game_player_status_update_url' game_id=game.id %}">
                        {% csrf_token %}
                        <div class="flex items-center py-2">
                            <label for="play_slot_{{ cancelled_player.pk }}" class="flex justify-center w-28">
                                {% if user.is_superuser or cancelled_player.user.username == user.username %}

                                    <input type="hidden" name="play_slot_{{ cancelled_player.pk }}" value="off">
                                    <input type="checkbox"
                                           name="play_slot_{{ cancelled_player.pk }}"
                                           value="on"
                                           id="play_slot_{{ cancelled_player.pk }}"
                                           class="toggle toggle-primary"
                                           {% if cancelled_player in confirmed_players_for_game %}checked{% endif %}
                                           {% if number_of_confirmed_players >= 10 and cancelled_player not in confirmed_players_for_game %}disabled
                                           title="There is no free slots in the squad" {% endif %}
                                           onchange="this.form.submit()">
                                {% else %}
                                    <div style="width: 64px; height: 24px;"></div>
                                {% endif %}
                            </label>
                            <span class="w-48 text-center dark:text-gray-300"><a
                                    href="{% url 'player_details_url' player_id=cancelled_player.pk %}">{{ cancelled_player|get_display_name }}</a></span>
                            <span class="w-48 flex justify-center">
                            {% if substitute %}
                                <span class="badge badge-success">{{ substitute|get_display_name }}</span>
                            {% else %}
                                <span class="badge badge-error text-error-content">free slot</span>
                            {% endif %}
                        </span>
                        </div>
                    </form>
                {% endfor %}

                <div class="font-bold bg-gray-700 text-gray-200 px-2 py-1 rounded mt-4 mb-2 text-center">
                    Reserved players
                </div>
                <div class="flex items-center font-bold text-gray-300 rounded-t p-2">
                    <span class="w-28 text-center">Play</span>
                    <span class="w-48 text-center">Player</span>
                </div>

                {% for confirmed_player in confirmed_players_for_game %}
                    <form method="post" action="{% url 'game_player_status_update_url' game_id=game.id %}">
                        {% csrf_token %}
                        <div class="flex items-center py-2">
                            <label for="play_slot_{{ confirmed_player.pk }}" class="flex justify-center w-28">
                                {% if user.is_superuser or confirmed_player.user.username == user.username %}
                                    <input type="hidden" name="play_slot_{{ confirmed_player.pk }}" value="off">
                                    <input type="checkbox"
                                           name="play_slot_{{ confirmed_player.pk }}"
                                           value="on"
                                           id="play_slot_{{ confirmed_player.pk }}"
                                           class="toggle toggle-primary"
                                           checked
                                           onchange="this.form.submit()">
                                {% else %}
                                    <div style="width: 64px; height: 24px;"></div>
                                {% endif %}
                            </label>
                            <span class="w-48 text-center dark:text-gray-300"><a
                                    href="{% url 'player_details_url' player_id=confirmed_player.pk %}">{{ confirmed_player|get_display_name }}</a></span>
                        </div>
                    </form>
                {% endfor %}
                {% for reserved_player in reserved_players_for_game %}
                    <form method="post" action="{% url 'game_player_status_update_url' game_id=game.id %}">
                        {% csrf_token %}
                        <div class="flex items-center py-2">
                            <label for="play_slot_{{ reserved_player.pk }}" class="flex justify-center w-28">
                                {% if user.is_superuser or reserved_player.user.username == user.username %}
                                    <input type="hidden" name="play_slot_{{ reserved_player.pk }}" value="off">
                                    <input type="checkbox"
                                           name="play_slot_{{ reserved_player.pk }}"
                                           value="on"
                                           id="play_slot_{{ reserved_player.pk }}"
                                           class="toggle toggle-primary"
                                           {% if reserved_player in confirmed_players_for_game %}checked{% endif %}
                                           onchange="this.form.submit()">
                                {% else %}
                                    <div style="width: 64px; height: 24px;"></div>
                                {% endif %}
                            </label>
                            <span class="w-48 text-center dark:text-gray-300"><a
                                    href="{% url 'player_details_url' player_id=reserved_player.pk %}">{{ reserved_player|get_display_name }}</a></span>
                        </div>
                    </form>
                {% endfor %}
            </div>

        </div>

        <div class="p-4 flex flex-col gap-4">
            <div class="card shadow-lg text-center bg-base-100 text-xl font-semibold">
                Booking history for this game
            </div>
            <table class="table">
                <thead>
                <tr>
                    <th>Player</th>
                    <th>Status</th>
                    <th>Created</th>
                </tr>
                </thead>
                <tbody>
                {% for record in booking_history %}
                    <tr>
                        <td>{{ record.player|get_display_name }}</td>
                        <td>{{ record.status }}</td>
                        <td>{{ record.creation_date|date:'d M Y, H:i:s' }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
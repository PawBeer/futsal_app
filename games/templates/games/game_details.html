{% extends 'index.html' %}
{% load player_extras %}
{% block page_title %}
    Game Details {{ game.when }}
{% endblock %}

{% block content %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 p-2 max-w-full bg-base-100 rounded-lg shadow-lg">

        <div class="flex flex-col items-center space-y-6 p-6 bg-base-100 rounded-xl shadow-lg">
            <form method="post" action="{% url 'game_status_update_url' game_id=game.id %}"
                  class="w-full max-w-md space-y-6">
                {% csrf_token %}

                <div class="text-center">
                    <p class="text-xl md:text-3xl lg:text-4xl text-base-content font-bold tracking-tight mb-4">
                        {{ game.when|date:'d M Y' }}
                    </p>

                    <div class="flex justify-center mb-8">
                        {% if number_of_confirmed_players >= 10 %}
                            <div class="radial-progress bg-primary/10 text-success font-bold text-xl"
                                 style="--size:120px; --thickness: 8px; --value:100;"
                                 role="progressbar" aria-valuenow="{{ number_of_confirmed_players }}">
                                10+
                            </div>
                        {% elif number_of_confirmed_players >= 8 %}
                            <div class="radial-progress bg-success/10 text-warning font-bold text-xl"
                                 style="--size:120px; --thickness: 8px; --value:{% widthratio number_of_confirmed_players 1 10 %};"
                                 role="progressbar">{{ number_of_confirmed_players }}</div>
                        {% else %}
                            <div class="radial-progress bg-error/10 text-error font-bold text-xl"
                                 style="--size:120px; --thickness: 8px; --value:{% widthratio number_of_confirmed_players 1 10 %};"
                                 role="progressbar">{{ number_of_confirmed_players }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-control w-full max-w-xs mx-auto">
                    <label for="status" class="label">
                        <span class="label-text font-semibold text-base-content/90">Status</span>
                    </label>
                    {% if user.is_superuser %}
                        <select id="status" name="status" class="select select-bordered w-full">
                            {% for status_option in status_options %}
                                <option value="{{ status_option }}"
                                        {% if status_option == game.status %}selected{% endif %}>
                                    {{ status_option }}
                                </option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <div class="font-semibold text-base-content/90 bg-base-200 px-4 py-3 rounded-lg cursor-default select-none">
                            {{ game.status }}
                        </div>
                    {% endif %}
                </div>

                <div class="form-control w-full max-w-xs mx-auto">
                    <label for="description" class="label">
                        <span class="label-text font-semibold text-base-content/90">Description</span>
                    </label>
                    {% if user.is_superuser %}
                        <textarea id="description" name="description" rows="4"
                                  class="textarea textarea-bordered w-full resize-vertical">{{ game.description }}</textarea>
                    {% else %}
                        <div class="font-medium text-base-content/90 bg-base-200 px-4 py-3 rounded-lg cursor-default select-none min-h-[100px] flex items-start leading-relaxed pt-2">
                            {{ game.description|default:"No description" }}
                        </div>
                    {% endif %}
                </div>


                {% if user.is_authenticated and user.is_superuser %}
                    <div class="pt-4">
                        <button type="submit" class="btn btn-primary w-full shadow-lg hover:shadow-xl">
                            Update Game Details
                        </button>
                    </div>
                {% endif %}
            </form>
        </div>

        <div class="flex flex-col space-y-6 p-6 bg-base-100 rounded-xl shadow-lg">

            <!-- Planned players -->
            <div class="divide-y divide-base-200">
                <div class="bg-base-200 px-6 py-4 rounded-t-xl">
                    <h3 class="text-xl font-semibold text-base-content text-center">Planned Players</h3>
                </div>
                <div class="overflow-x-auto rounded-b-xl">
                    <table class="table w-full">
                        <thead>
                        <tr>
                            <th class="w-20 text-center">Play</th>
                            <th class="w-64 text-left">Player</th>
                            <th class="w-48 text-center">Substitute</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for planned_player in planned_players_for_game %}
                            <form method="post" action="{% url 'game_player_status_update_url' game_id=game.id %}">
                                {% csrf_token %}
                                <tr class="hover">
                                    <td class="text-center py-3">
                                        {% if user.is_superuser or planned_player.user.username == user.username %}
                                            <input type="hidden" name="play_slot_{{ planned_player.pk }}" value="off">
                                            <input type="checkbox" name="play_slot_{{ planned_player.pk }}" value="on"
                                                   id="play_slot_{{ planned_player.pk }}" class="toggle toggle-primary"
                                                   checked onchange="this.form.submit()">
                                        {% else %}
                                            <div class="w-6 h-6 bg-success rounded-full flex items-center justify-center text-success-content text-xs font-bold shadow-md mx-auto">
                                                ✓
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td class="font-medium">
                                        <a href="{% url 'player_details_url' player_id=planned_player.pk %}"
                                           class="link link-primary">
                                            {{ planned_player|get_display_name }}
                                        </a>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-ghost">–</span>
                                    </td>
                                </tr>
                            </form>
                        {% endfor %}

                        {% for cancelled_player, substitute in cancelled_with_substitutes %}
                            <form method="post" action="{% url 'game_player_status_update_url' game_id=game.id %}">
                                {% csrf_token %}
                                <tr class="hover">
                                    <td class="text-center py-3">
                                        {% if user.is_superuser or cancelled_player.user.username == user.username %}
                                            <input type="hidden" name="play_slot_{{ cancelled_player.pk }}" value="off">
                                            <input type="checkbox" name="play_slot_{{ cancelled_player.pk }}" value="on"
                                                   id="play_slot_{{ cancelled_player.pk }}"
                                                   class="toggle toggle-primary"
                                                   {% if cancelled_player in confirmed_players_for_game %}checked{% endif %}
                                                   {% if number_of_confirmed_players >= 10 and cancelled_player not in confirmed_players_for_game %}disabled
                                                   title="No free slots"{% endif %}
                                                   onchange="this.form.submit()">
                                        {% else %}
                                            <div class="w-6 h-6 bg-error rounded-full flex items-center justify-center text-error-content text-xs font-bold shadow-md mx-auto">
                                                ✗
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td class="font-medium">
                                        <a href="{% url 'player_details_url' player_id=cancelled_player.pk %}"
                                           class="link link-primary">
                                            {{ cancelled_player|get_display_name }}
                                        </a>
                                    </td>
                                    <td class="text-center">
                                        {% if substitute %}
                                            <span class="badge badge-success">{{ substitute|get_display_name }}</span>
                                        {% else %}
                                            <span class="badge badge-error text-error-content">free slot</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </form>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

<!-- Reserved/Confirmed players - dla superuser LUB gracza z odpowiednim statusem -->
{% if user.is_superuser or reserved_players_for_game|length > 0 %}
<div class="divide-y divide-base-200">
    <div class="bg-base-200 px-6 py-4 rounded-t-xl">
        <h3 class="text-xl font-semibold text-base-content text-center">Reserve List</h3>
    </div>
    <div class="overflow-x-auto rounded-b-xl">
        <table class="table w-full">
            <thead>
            <tr>
                <th class="w-20 text-center font-semibold text-base-content/70 uppercase tracking-wide">Play</th>
                <th class="w-64 text-left font-semibold text-base-content/70 uppercase tracking-wide">Player</th>
            </tr>
            </thead>
            <tbody>
            <!-- Confirmed players (wszystkie + własne dla gracza) -->
            {% for confirmed_player in confirmed_players_for_game %}
                {% if user.is_superuser or confirmed_player.user.username == user.username %}
                    <form method="post" action="{% url 'game_player_status_update_url' game_id=game.id %}">
                        {% csrf_token %}
                        <tr class="hover bg-success/10">
                            <td class="text-center py-3">
                                {% if user.is_superuser or confirmed_player.user.username == user.username %}
                                    <input type="hidden" name="play_slot_{{ confirmed_player.pk }}" value="off">
                                    <input type="checkbox" name="play_slot_{{ confirmed_player.pk }}" value="on"
                                           id="play_slot_{{ confirmed_player.pk }}" class="toggle toggle-primary"
                                           checked onchange="this.form.submit()">
                                {% else %}
                                    <div class="w-6 h-6 bg-success rounded-full flex items-center justify-center text-success-content text-xs font-bold shadow-md mx-auto">
                                        ✓
                                    </div>
                                {% endif %}
                            </td>
                            <td class="font-medium py-3 flex items-center gap-2">
                                <a href="{% url 'player_details_url' player_id=confirmed_player.pk %}" class="link link-primary flex-1">
                                    {{ confirmed_player|get_display_name }}
                                </a>
                                <span class="badge badge-success badge-xs">Confirmed</span>
                            </td>
                        </tr>
                    </form>
                {% endif %}
            {% endfor %}
            
            <!-- Reserved players -->
            {% for reserved_player in reserved_players_for_game %}
                {% if reserved_player.user.username == user.username or user.is_superuser %}
                    <form method="post" action="{% url 'game_player_status_update_url' game_id=game.id %}">
                        {% csrf_token %}
                        <tr class="hover {% if reserved_player.status == 'reserved' %}opacity-75 bg-warning/10{% endif %}">
                            <td class="text-center py-3">
                                {% if user.is_superuser or reserved_player.user.username == user.username %}
                                    <input type="hidden" name="play_slot_{{ reserved_player.pk }}" value="off">
                                    <input type="checkbox" name="play_slot_{{ reserved_player.pk }}" value="on"
                                           id="play_slot_{{ reserved_player.pk }}" class="toggle toggle-primary"
                                           {% if reserved_player in confirmed_players_for_game %}checked{% endif %}
                                           onchange="this.form.submit()">
                                {% else %}
                                    <div class="w-6 h-6 bg-base-200 rounded-full mx-auto"></div>
                                {% endif %}
                            </td>
                            <td class="font-medium py-3 flex items-center gap-2">
                                <a href="{% url 'player_details_url' player_id=reserved_player.pk %}" class="link link-primary flex-1">
                                    {{ reserved_player|get_display_name }}
                                </a>
                                {% if reserved_player.status == 'reserved' %}
                                    <span class="badge badge-warning badge-xs">Reserve</span>
                                {% endif %}
                            </td>
                        </tr>
                    </form>
                {% endif %}
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}


        </div>


        <!-- Booking History -->
        <div class="flex flex-col space-y-6 p-6 bg-base-100 rounded-xl shadow-lg">

            <div class="divide-y divide-base-200">
                <div class="bg-base-200 px-6 py-4 rounded-t-xl">
                    <h3 class="text-xl font-semibold text-base-content text-center underline decoration-primary decoration-2 underline-offset-4">
                        Booking History
                    </h3>
                </div>
                <div class="overflow-x-auto rounded-b-xl">
                    <table class="table w-full">
                        <thead>
                        <tr>
                            <th class="w-40 text-left font-semibold text-base-content/70 uppercase tracking-wide">
                                Player
                            </th>
                            <th class="w-32 text-left font-semibold text-base-content/70 uppercase tracking-wide">
                                Status
                            </th>
                            <th class="w-40 text-left font-semibold text-base-content/70 uppercase tracking-wide">
                                Created
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for record in booking_history %}
                            <tr class="hover">
                                <td class="font-medium py-3">
                                    <a href="{% url 'player_details_url' player_id=record.player.pk %}"
                                       class="link link-primary font-medium">
                                        {{ record.player|get_display_name }}
                                    </a>
                                </td>
                                <td class="py-3 font-medium text-base-content/90">
                                    {{ record.status|title }}
                                </td>
                                <td class="py-3 text-sm text-base-content/80">
                                    {{ record.creation_date|date:'d M Y, H:i:s' }}
                                </td>
                            </tr>

                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
{% endblock %}